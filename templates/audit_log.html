{% extends "base.html" %}

{% block title %}System Activity Audit Log{% endblock %}
{% block page_title %}System Activity Audit Log{% endblock %}

{% block extra_css %}
<style>
.password-container {
    position: relative;
}

.password-toggle {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: #6c757d;
    cursor: pointer;
    padding: 0;
    width: 20px;
    height: 20px;
}

.password-toggle:hover {
    color: #495057;
}

.password-container .form-control {
    padding-right: 45px;
}

@media print {
    .no-print { display: none !important; }
    .print-only { display: block !important; }
    
    body { font-size: 12px; }
    .card { border: 1px solid #000 !important; box-shadow: none !important; }
    .table { font-size: 11px; }
    .badge { border: 1px solid #000; background: white !important; color: black !important; }
    
    .page-break { page-break-before: always; }
    .avoid-break { page-break-inside: avoid; }
    
    .print-header {
        text-align: center;
        border-bottom: 2px solid #000;
        margin-bottom: 20px;
        padding-bottom: 10px;
    }
}

.print-only { display: none; }
.print-controls { margin-bottom: 20px; }
</style>
{% endblock %}

{% block content %}
<!-- Print Controls (hidden when printing) -->
<div class="no-print print-controls">
    <div class="row">
        <div class="col-md-8">
            <div class="btn-group" role="group">
                <button onclick="window.print()" class="btn btn-primary">
                    <i class="fas fa-print"></i> Print Report
                </button>
                <button onclick="exportToCSV()" class="btn btn-success">
                    <i class="fas fa-file-csv"></i> Export CSV
                </button>
            </div>
        </div>
        <div class="col-md-4 text-end">
            <div class="form-check form-switch d-inline-block me-3">
                <input class="form-check-input" type="checkbox" id="showOnlyAdmins" onchange="toggleFilter()">
                <label class="form-check-label" for="showOnlyAdmins">Admins Only</label>
            </div>
            <div class="form-check form-switch d-inline-block">
                <input class="form-check-input" type="checkbox" id="showOnlyUsers" onchange="toggleFilter()">
                <label class="form-check-label" for="showOnlyUsers">Users Only</label>
            </div>
        </div>
    </div>
</div>

<!-- Print Header (only visible when printing) -->
<div class="print-only print-header">
    <h2>AllerSafe Recipe System - Activity Audit Log</h2>
    <p>Generated on: <span id="print-date"></span></p>
    <p>Total Entries: {{ logs|length }}</p>
</div>

<!-- Summary Cards -->
<div class="row mb-4 no-print">
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                {% set admin_count = logs|selectattr("admin_id")|list|length %}
                <h3>{{ admin_count }}</h3>
                <p class="mb-0 text-primary">Admin Actions</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                {% set user_count = logs|selectattr("user_id")|list|length %}
                <h3>{{ user_count }}</h3>
                <p class="mb-0 text-success">User Actions</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <h3>{{ logs|length }}</h3>
                <p class="mb-0 text-info">Total Entries</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                {% set login_count = [] %}
                {% for log in logs %}
                    {% if 'login' in log.action.lower() %}
                        {% set _ = login_count.append(1) %}
                    {% endif %}
                {% endfor %}
                <h3>{{ login_count|length }}</h3>
                <p class="mb-0 text-warning">Login Events</p>
            </div>
        </div>
    </div>
</div>

<!-- Main Audit Log Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">System Activity History</h5>
        <span class="badge bg-primary">{{ logs|length }} entries</span>
    </div>
    <div class="card-body p-0">
        {% if logs %}
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="auditTable">
                <thead class="table-dark">
                    <tr>
                        <th>Date/Time</th>
                        <th>User Type</th>
                        <th>User</th>
                        <th>Action</th>
                        <th>Target</th>
                        <th>Details</th>
                        <th class="no-print">IP Address</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in logs %}
                    <tr class="audit-row avoid-break" 
                        data-user-type="{{ 'admin' if log.admin_id else 'user' if log.user_id else 'system' }}">
                        <td>
                            <small>{{ log.created_at }}</small>
                        </td>
                        <td>
                            {% if log.admin_id %}
                                <span class="badge bg-warning text-dark">Admin</span>
                            {% elif log.user_id %}
                                <span class="badge bg-info text-white">User</span>
                            {% else %}
                                <span class="badge bg-secondary">System</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if log.admin_id and log.admin %}
                                <span class="fw-bold text-primary">{{ log.admin.username }}</span>
                            {% elif log.user_id and log.user %}
                                <span class="fw-bold text-success">{{ log.user.username }}</span>
                            {% else %}
                                <span class="text-muted">System</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if 'login' in log.action.lower() %}
                                <span class="badge bg-success">{{ log.action }}</span>
                            {% elif 'logout' in log.action.lower() %}
                                <span class="badge bg-secondary">{{ log.action }}</span>
                            {% elif 'delete' in log.action.lower() %}
                                <span class="badge bg-danger">{{ log.action }}</span>
                            {% elif 'suspend' in log.action.lower() %}
                                <span class="badge bg-warning">{{ log.action }}</span>
                            {% elif 'create' in log.action.lower() %}
                                <span class="badge bg-primary">{{ log.action }}</span>
                            {% else %}
                                <span class="badge bg-info">{{ log.action }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if log.target_type %}
                                <span class="text-muted">{{ log.target_type|title }}</span>
                                {% if log.target_id %}
                                    <small>#{{ log.target_id }}</small>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">—</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if log.details %}
                                <small>{{ log.details }}</small>
                            {% else %}
                                <span class="text-muted">—</span>
                            {% endif %}
                        </td>
                        <td class="no-print">
                            <small class="text-muted">{{ log.ip_address or '—' }}</small>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="p-4 text-center">
            <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
            <h5>No Activity Recorded</h5>
            <p class="text-muted">No system activities have been logged yet.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Print Footer (only visible when printing) -->
<div class="print-only mt-4" style="border-top: 1px solid #000; padding-top: 10px; text-align: center; font-size: 10px;">
    <p>This report contains {{ logs|length }} audit log entries | AllerSafe Recipe Management System</p>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Password toggle function
function togglePassword(fieldId) {
    const passwordField = document.getElementById(fieldId);
    const eyeIcon = document.getElementById(fieldId + '-eye');
    
    if (passwordField.type === 'password') {
        passwordField.type = 'text';
        eyeIcon.classList.remove('fa-eye');
        eyeIcon.classList.add('fa-eye-slash');
    } else {
        passwordField.type = 'password';
        eyeIcon.classList.remove('fa-eye-slash');
        eyeIcon.classList.add('fa-eye');
    }
}

// Set print date
document.getElementById('print-date').textContent = new Date().toLocaleString();

// Toggle filters
function toggleFilter() {
    const showAdmins = document.getElementById('showOnlyAdmins').checked;
    const showUsers = document.getElementById('showOnlyUsers').checked;
    const rows = document.querySelectorAll('.audit-row');
    
    rows.forEach(row => {
        const userType = row.getAttribute('data-user-type');
        let show = true;
        
        if (showAdmins && showUsers) {
            show = userType === 'admin' || userType === 'user';
        } else if (showAdmins) {
            show = userType === 'admin';
        } else if (showUsers) {
            show = userType === 'user';
        }
        
        row.style.display = show ? '' : 'none';
    });
}

// Export to CSV
function exportToCSV() {
    const table = document.getElementById('auditTable');
    const rows = Array.from(table.querySelectorAll('tr'));
    
    const csvContent = rows.map(row => {
        const cells = Array.from(row.querySelectorAll('th, td'));
        return cells.map(cell => {
            let text = cell.textContent.trim();
            text = text.replace(/"/g, '""');
            return text.includes(',') ? `"${text}"` : text;
        }).join(',');
    }).join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `audit_log_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Print function
window.addEventListener('beforeprint', function() {
    document.getElementById('print-date').textContent = new Date().toLocaleString();
});
</script>
{% endblock %}